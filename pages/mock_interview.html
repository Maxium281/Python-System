<!-- -*- coding: utf-8 -*- -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>模拟面试 - Python面试题学习系统</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='icons/font-awesome.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
</head>
<body>
  <!-- 导航栏（保持与你现有页面一致的风格） -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('main.index') }}">Python面试题系统</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.index') }}">首页</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('question.question_category') }}">题库分类</a></li>
          <li class="nav-item"><a class="nav-link active" href="{{ url_for('interview.mock_interview') }}">模拟面试</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('progress.progress') }}">我的进度</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">模拟面试</h5>
          <small class="text-muted" id="metaLine">未开始</small>
        </div>
        <span class="badge bg-danger" id="countdown">--:--</span>
      </div>

      <div class="card-body">
        <!-- 设置区 -->
        <div class="row g-2 align-items-end" id="setupBox">
          <div class="col-md-3">
            <label class="form-label">题目数量</label>
            <input class="form-control" id="countInput" type="number" min="1" max="50" value="10">
          </div>
          <div class="col-md-3">
            <label class="form-label">分类</label>
            <select class="form-select" id="categoryInput">
              <option value="all" selected>全部（题库三类合并）</option>
              <option value="basic">基础语法</option>
              <option value="framework">框架相关</option>
              <option value="project">项目经验</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">限时（分钟）</label>
            <input class="form-control" id="timeInput" type="number" min="1" max="60" value="10">
          </div>
          <div class="col-md-3">
            <button class="btn btn-success w-100" id="startBtn">
              <i class="fa fa-play"></i> 开始模拟
            </button>
          </div>
        </div>

        <hr>

        <!-- 题目区 -->
        <div id="questionBox">
          <h5 id="questionTitle" class="mb-2">请点击“开始模拟”</h5>
          <p class="text-muted" id="questionType">题目类型 | 难度：--</p>

          <div class="list-group mb-3" id="optionList"></div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary" id="submitBtn" disabled>
              <span class="spinner-border spinner-border-sm me-2 d-none" id="submitSpinner"></span>
              提交并下一题
            </button>
            <button class="btn btn-secondary" id="finishBtn" disabled>结束并查看结果</button>
          </div>

          <div class="mt-3" id="feedbackBox"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    let timer = null;
    let startTs = 0;
    let timeLimit = 0;
    let currentQuestion = null;

    function setCountdown() {
      const now = Math.floor(Date.now() / 1000);
      const end = startTs + timeLimit;
      const left = Math.max(0, end - now);
      const mm = String(Math.floor(left / 60)).padStart(2, "0");
      const ss = String(left % 60).padStart(2, "0");
      document.getElementById("countdown").textContent = `${mm}:${ss}`;

      if (left <= 0) {
        clearInterval(timer);
        timer = null;
        finishExam();
      }
    }

    function getSelectedAnswer() {
      const checked = document.querySelectorAll('input[name="user_answer"]:checked');
      if (!checked.length) return "";
      return Array.from(checked).map(i => i.value).sort().join("");
    }

    function syncSubmitEnabled() {
      document.getElementById("submitBtn").disabled = !getSelectedAnswer();
    }

    function renderQuestion(q, index, total) {
      currentQuestion = q;
      document.getElementById("feedbackBox").innerHTML = "";

      document.getElementById("metaLine").textContent = `进度：${index}/${total} | 分类：${escapeHtml(q.category || "")}`;
      document.getElementById("questionTitle").textContent = `题目 ${q.id}：${q.title}`;
      document.getElementById("questionType").textContent =
        `${q.type === "single" ? "单选题" : "多选题"} | 难度：${q.difficulty || "Easy"}`;

      const inputType = q.type === "single" ? "radio" : "checkbox";
      let html = "";
      for (const opt of (q.options || [])) {
        html += `
          <label class="list-group-item">
            <input class="form-check-input me-2" type="${inputType}" name="user_answer" value="${escapeHtml(opt.option_key)}">
            ${escapeHtml(opt.option_key)}. ${escapeHtml(opt.option_content)}
          </label>
        `;
      }
      const optionList = document.getElementById("optionList");
      optionList.innerHTML = html;
      optionList.onchange = syncSubmitEnabled;
      syncSubmitEnabled();

      document.getElementById("submitBtn").disabled = true;
      document.getElementById("finishBtn").disabled = false;
    }

    async function startExam() {
      const count = Number(document.getElementById("countInput").value || 10);
      const category = document.getElementById("categoryInput").value || "all";
      const minutes = Number(document.getElementById("timeInput").value || 10);

      document.getElementById("startBtn").disabled = true;

      const res = await fetch("/exam/api/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          count: count,
          category: category,
          time_limit_seconds: Math.max(60, Math.min(3600, minutes * 60)),
        }),
      });

      const payload = await res.json().catch(() => null);
      if (!payload || !payload.success) {
        document.getElementById("startBtn").disabled = false;
        document.getElementById("feedbackBox").innerHTML =
          `<div class="alert alert-danger"><i class="fa fa-times-circle"></i> ${escapeHtml(payload?.msg || "开始失败")}</div>`;
        return;
      }

      startTs = payload.data.start_ts;
      timeLimit = payload.data.time_limit_seconds;

      // 启动计时
      if (timer) clearInterval(timer);
      setCountdown();
      timer = setInterval(setCountdown, 1000);

      // 锁定设置区
      document.getElementById("setupBox").querySelectorAll("input,select,button").forEach(el => el.disabled = true);

      renderQuestion(payload.data.question, payload.data.index, payload.data.total);
    }

    async function loadCurrentQuestion() {
      const res = await fetch("/exam/api/question", { method: "GET", cache: "no-store" });
      const payload = await res.json().catch(() => null);
      if (!payload || !payload.success) return;
      startTs = payload.data.start_ts;
      timeLimit = payload.data.time_limit_seconds;
      if (!timer) {
        setCountdown();
        timer = setInterval(setCountdown, 1000);
      }
      // 同步锁定设置区
      document.getElementById("setupBox").querySelectorAll("input,select,button").forEach(el => el.disabled = true);
      renderQuestion(payload.data.question, payload.data.index, payload.data.total);
    }

    async function submitAndNext() {
      const ans = getSelectedAnswer();
      if (!ans || !currentQuestion) return;

      const btn = document.getElementById("submitBtn");
      const sp = document.getElementById("submitSpinner");
      btn.disabled = true;
      sp.classList.remove("d-none");

      const res = await fetch("/exam/api/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question_id: currentQuestion.id, user_answer: ans }),
      });

      const payload = await res.json().catch(() => null);
      sp.classList.add("d-none");

      if (!payload || !payload.success) {
        btn.disabled = false;
        document.getElementById("feedbackBox").innerHTML =
          `<div class="alert alert-danger"><i class="fa fa-times-circle"></i> ${escapeHtml(payload?.msg || "提交失败")}</div>`;
        return;
      }

      const d = payload.data;
      document.getElementById("feedbackBox").innerHTML =
        d.is_correct
          ? `<div class="alert alert-success"><i class="fa fa-check-circle"></i> 回答正确</div>`
          : `<div class="alert alert-warning"><i class="fa fa-exclamation-triangle"></i> 回答错误，正确答案：${escapeHtml(d.correct_answer || "--")}</div>`;

      if (d.finished) {
        finishExam();
        return;
      }

      // 拉取下一题
      await loadCurrentQuestion();
    }

    async function finishExam() {
      document.getElementById("submitBtn").disabled = true;
      document.getElementById("finishBtn").disabled = true;

      const res = await fetch("/exam/api/finish", { method: "POST" });
      const payload = await res.json().catch(() => null);

      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      document.getElementById("countdown").textContent = "--:--";

      if (!payload || !payload.success) {
        document.getElementById("feedbackBox").innerHTML =
          `<div class="alert alert-danger"><i class="fa fa-times-circle"></i> 结束失败</div>`;
        return;
      }

      const d = payload.data;
      document.getElementById("feedbackBox").innerHTML = `
        <div class="alert alert-info">
          <strong>本次模拟结束</strong><br>
          总题数：${d.total}，已答：${d.answered}，正确：${d.correct}，错误：${d.wrong}，准确率：${d.accuracy}%
        </div>
      `;

      // 允许重新开始
      document.getElementById("setupBox").querySelectorAll("input,select,button").forEach(el => el.disabled = false);
      document.getElementById("startBtn").disabled = false;
      document.getElementById("metaLine").textContent = "未开始";
      document.getElementById("optionList").innerHTML = "";
      document.getElementById("questionTitle").textContent = "请点击“开始模拟”";
      document.getElementById("questionType").textContent = "题目类型 | 难度：--";
      currentQuestion = null;
    }

    document.getElementById("startBtn").addEventListener("click", startExam);
    document.getElementById("submitBtn").addEventListener("click", submitAndNext);
    document.getElementById("finishBtn").addEventListener("click", finishExam);

    // 若用户刷新页面：尝试恢复进行中的模拟
    document.addEventListener("DOMContentLoaded", function () {
      loadCurrentQuestion().catch(() => {});
    });
  </script>
</body>
</html>
