<!-- -*- coding: utf-8 -*- -->
<!-- templates/question_category.html -->
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- qc-template-marker: question_category.html -->
    <meta name="qc-template" content="pages/question_category.html" />
    <title>题库分类 - Python面试题学习系统</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='icons/font-awesome.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
  </head>
  <body data-qc-template="pages/question_category.html">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('main.index') }}"
          >Python面试题系统</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.index') }}">首页</a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link active"
                href="{{ url_for('question.question_category') }}"
                >题库分类</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('interview.mock_interview') }}"
                >模拟面试</a
              >
            </li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('progress.progress') }}">我的进度</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-4">
      <div class="card">
        <div class="card-header">
          <ul
            class="nav nav-tabs card-header-tabs"
            id="categoryTabs"
            role="tablist"
          >
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="basic-tab"
                data-bs-toggle="tab"
                data-bs-target="#basic"
                type="button"
                role="tab"
              >
                基础语法
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="framework-tab"
                data-bs-toggle="tab"
                data-bs-target="#framework"
                type="button"
                role="tab"
              >
                框架相关
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="project-tab"
                data-bs-toggle="tab"
                data-bs-target="#project"
                type="button"
                role="tab"
              >
                项目经验
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="categoryTabsContent">
            <!-- 基础语法分类 -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h6>基础语法题目</h6>
                <span class="badge bg-primary" id="basicCount">加载中...</span>
              </div>
              <div id="basicQuestionList" class="list-group">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                  </div>
                  <p class="mt-2 text-muted">正在加载题目...</p>
                </div>
              </div>
            </div>
            <!-- 框架相关分类 -->
            <div class="tab-pane fade" id="framework" role="tabpanel">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h6>框架相关题目</h6>
                <span class="badge bg-success" id="frameworkCount"
                  >加载中...</span
                >
              </div>
              <div id="frameworkQuestionList" class="list-group">
                <div class="text-center py-4">
                  <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">加载中...</span>
                  </div>
                  <p class="mt-2 text-muted">正在加载题目...</p>
                </div>
              </div>
            </div>
            <!-- 项目经验分类 -->
            <div class="tab-pane fade" id="project" role="tabpanel">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h6>项目经验题目</h6>
                <span class="badge bg-warning" id="projectCount"
                  >加载中...</span
                >
              </div>
              <div id="projectQuestionList" class="list-group">
                <div class="text-center py-4">
                  <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">加载中...</span>
                  </div>
                  <p class="mt-2 text-muted">正在加载题目...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-5 py-3 bg-light text-center">
      <p>© 2024 Python面试题学习系统（单机版）| Flask后端 + 本地数据库</p>
    </footer>

    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
      // API基础URL
      const API_BASE = "/question/api";

      function setLoading(containerId, spinnerColorClass) {
        const el = document.getElementById(containerId);
        if (!el) return;
        el.innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border ${spinnerColorClass}" role="status">
              <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2 text-muted">正在加载题目...</p>
          </div>
        `;
      }

      function setAlert(containerId, type, htmlText) {
        const el = document.getElementById(containerId);
        if (!el) return;
        el.innerHTML = `<div class="alert alert-${type}">${htmlText}</div>`;
      }

      function categoryBadge(category) {
        const c = category || "";
        let badgeClass = "bg-secondary";
        let text = c;

        if (c.includes("Python Basics") || c.includes("基础")) {
          badgeClass = "bg-primary";
          text = "基础";
        } else if (c.includes("Flask") || c.includes("框架")) {
          badgeClass = "bg-success";
          text = "框架";
        } else if (c.includes("Project") || c.includes("项目")) {
          badgeClass = "bg-warning";
          text = "项目";
        }
        return { badgeClass, text };
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function renderQuestionList(containerId, questions) {
        const el = document.getElementById(containerId);
        if (!el) return;

        if (!Array.isArray(questions) || questions.length === 0) {
          el.innerHTML = `
            <div class="alert alert-info">
              <i class="fa fa-info-circle"></i> 该分类下暂无题目
            </div>
          `;
          return;
        }

        let html = "";
        for (const q of questions) {
          const b = categoryBadge(q.category);
          html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="/question/detail/${q.id}" class="text-decoration-none flex-grow-1">
                ${q.id}. ${escapeHtml(q.title)}
              </a>
              <span class="badge ${b.badgeClass} rounded-pill">${escapeHtml(b.text)}</span>
            </li>
          `;
        }
        el.innerHTML = html;
      }

      async function loadQuestions(category, containerId, countId, spinnerColorClass) {
        setLoading(containerId, spinnerColorClass);

        const countEl = document.getElementById(countId);
        if (countEl) countEl.textContent = "加载中...";

        try {
          const url = `${API_BASE}/questions?category=${encodeURIComponent(category)}`;
          const res = await fetch(url, { method: "GET", cache: "no-store" });

          if (!res.ok) {
            setAlert(
              containerId,
              "danger",
              `<i class="fa fa-times-circle"></i> 请求失败：HTTP ${res.status}`
            );
            return;
          }

          const payload = await res.json();

          // 兼容两种返回：
          // 1) {success:true, data:[...]}
          // 2) {data:[...]}
          const list = payload?.data;
          const ok = payload && (payload.success === true || Array.isArray(list));

          if (!ok) {
            setAlert(
              containerId,
              "warning",
              `<i class="fa fa-exclamation-triangle"></i> ${escapeHtml(payload?.msg || "加载失败")}`
            );
            return;
          }

          renderQuestionList(containerId, list || []);
          if (countEl) countEl.textContent = `${(list || []).length} 题`;
        } catch (e) {
          console.error("加载题目异常:", e);
          setAlert(
            containerId,
            "danger",
            `<i class="fa fa-times-circle"></i> 网络请求失败<br><small>请检查后端服务是否正常运行</small>`
          );
        }
      }

      // 让你随时能在 Console 手动触发（即使错过了启动时机）
      window.loadQuestions = loadQuestions;

      function boot() {
        // 持久标记：不依赖 console，也能在 Elements 里看到 <html data-qc-boot="1">
        document.documentElement.setAttribute("data-qc-boot", "1");

        // 如果你打开控制台太晚，看不到日志；所以这里不依赖日志判断是否执行
        loadQuestions("basic", "basicQuestionList", "basicCount", "text-primary");

        document.getElementById("basic-tab")?.addEventListener("click", function () {
          loadQuestions("basic", "basicQuestionList", "basicCount", "text-primary");
        });

        document.getElementById("framework-tab")?.addEventListener("click", function () {
          loadQuestions("framework", "frameworkQuestionList", "frameworkCount", "text-success");
        });

        document.getElementById("project-tab")?.addEventListener("click", function () {
          loadQuestions("project", "projectQuestionList", "projectCount", "text-warning");
        });
      }

      // 更稳：避免错过 DOMContentLoaded
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", boot);
      } else {
        boot();
      }
    </script>
  </body>
</html>
