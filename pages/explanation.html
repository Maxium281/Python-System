<!-- -*- coding: utf-8 -*- -->
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>答案解析 - Python面试题学习系统</title>
    <!-- 使用 Flask 的 url_for 加载本地静态资源 -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='icons/font-awesome.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
  </head>
  <body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">Python面试题系统</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.index') }}">首页</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('question.question_category') }}">题库分类</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('interview.mock_interview') }}">模拟面试</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('progress.progress') }}">我的进度</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-4">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0" id="questionTitle">
            题目 1：Python中列表和元组的区别是什么？
          </h5>
          <button id="collectBtn" class="btn btn-outline-warning">
            <i class="fa fa-star"></i> 收藏题目
          </button>
        </div>
        <div class="card-body">
          <!-- 替换现有的答题结果div -->
          <div class="mb-4" id="answerResult">
            <div class="row">
              <div class="col-md-6">
                <div
                  class="p-3 border rounded mb-3"
                  style="border-left: 5px solid #56ab2f !important"
                >
                  <h6 class="text-success mb-2">
                    <i class="fa fa-check-circle"></i> 正确答案：
                  </h6>
                  <h4 class="text-success fw-bold" id="correctAnswerDisplay">
                    B
                  </h4>
                </div>
              </div>
              <div class="col-md-6">
                <div
                  class="p-3 border rounded mb-3"
                  style="border-left: 5px solid #667eea !important"
                >
                  <h6 class="text-primary mb-2">
                    <i class="fa fa-user"></i> 你的答案：
                  </h6>
                  <h4 class="text-primary fw-bold" id="userAnswerDisplay">
                    （请先在答题页选择答案）
                  </h4>
                </div>
              </div>
            </div>
            <div class="text-center">
              <div
                id="scoreResult"
                class="badge p-3"
                style="
                  font-size: 1.1rem;
                  background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
                "
              >
                判分结果：--
              </div>
            </div>
          </div>
          <!-- 详细解析 -->
          <div class="mb-4" id="questionExplanation">
            <h6>解析：</h6>
            <p class="card-text">
              Python中列表（list）使用[]定义，是可变对象，支持增删改查操作；元组（tuple）使用()定义，是不可变对象，一旦创建无法修改元素。此外，元组的访问速度比列表更快，适合存储无需修改的数据；列表适合存储需要动态调整的数据。
            </p>
          </div>
          <!-- 考点总结 -->
          <div class="mb-4" id="knowledgePoint">
            <h6>考点：</h6>
            <span class="badge bg-secondary">Python基础数据类型</span>
          </div>
          <!-- 按钮组 -->
          <a href="{{ url_for('question.question_category') }}" class="btn btn-secondary"
            >返回题库</a
          >
          <a href="#" id="nextQuestionBtn" class="btn btn-primary ms-2"
            >下一题</a
          >
        </div>
      </div>
    </div>

    <!-- 页脚 -->
    <footer class="mt-5 py-3 bg-light text-center">
      <p>© 2024 Python面试题学习系统（单机版）| 无需联网，本地运行</p>
    </footer>

    <!-- 本地JS引入 -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
      const API_BASE = "/question/api";
      const questionId =
        window.location.pathname.split("/").pop() ||
        new URLSearchParams(window.location.search).get("question_id") ||
        1;

      function getParam(name) {
        return new URLSearchParams(window.location.search).get(name);
      }

      function normalizeAnswer(ans) {
        if (!ans) return "";
        return ans
          .toString()
          .toUpperCase()
          .replace(/[^A-D]/g, "")
          .split("")
          .sort()
          .join("");
      }

      function setScoreBadge(isCorrect) {
        const el = document.getElementById("scoreResult");
        const text = isCorrect ? "判分结果：正确" : "判分结果：错误";
        el.textContent = text;
      }

      async function loadExplanation() {
        const userAnswer = normalizeAnswer(getParam("user_answer") || "");
        const url = `${API_BASE}/explanation/${questionId}?user_answer=${encodeURIComponent(userAnswer)}`;

        const res = await fetch(url, { method: "GET" });
        const payload = await res.json();

        if (!payload || !payload.success) {
          document.getElementById("questionTitle").textContent = "加载失败";
          document.getElementById("questionExplanation").innerHTML =
            `<div class="alert alert-danger"><i class="fa fa-times-circle"></i> ${payload?.msg || "加载失败"}</div>`;
          return;
        }

        const data = payload.data;

        document.getElementById("questionTitle").textContent = `题目 ${data.id}：${data.title}`;
        document.getElementById("correctAnswerDisplay").textContent = data.correct_answer || "--";
        document.getElementById("userAnswerDisplay").textContent = data.user_answer || "未作答";
        setScoreBadge(!!data.is_correct);

        // 解析
        document.querySelector("#questionExplanation p")?.remove();
        document.getElementById("questionExplanation").innerHTML =
          `<h6>解析：</h6><p class="card-text">${data.analysis || "暂无解析"}</p>`;

        // 考点
        document.getElementById("knowledgePoint").innerHTML =
          `<h6>考点：</h6><span class="badge bg-secondary">${data.knowledge_point || "未标注"}</span>`;

        // 下一题（简单：id+1，不存在则回到1）
        const nextBtn = document.getElementById("nextQuestionBtn");
        nextBtn.href = `/question/answer?question_id=${Number(data.id) + 1}`;
      }

      async function toggleFavorite() {
        const res = await fetch("/progress/api/favorite/toggle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question_id: Number(questionId) }),
        });
        const payload = await res.json();
        if (!payload || !payload.success) {
          alert(payload?.msg || "操作失败");
          return;
        }

        const isFav = !!payload.data?.is_favorite;
        const btn = document.getElementById("collectBtn");
        if (isFav) {
          btn.className = "btn btn-warning";
          btn.innerHTML = '<i class="fa fa-star"></i> 已收藏';
        } else {
          btn.className = "btn btn-outline-warning";
          btn.innerHTML = '<i class="fa fa-star"></i> 收藏题目';
        }
      }

      document.getElementById("collectBtn").addEventListener("click", toggleFavorite);

      window.onload = function () {
        loadExplanation().catch((e) => {
          console.error(e);
          document.getElementById("questionExplanation").innerHTML =
            `<div class="alert alert-danger"><i class="fa fa-times-circle"></i> 加载异常</div>`;
        });
      };
    </script>
  </body>
</html>
