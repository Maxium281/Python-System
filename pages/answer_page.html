<!-- -*- coding: utf-8 -*- -->
<!-- templates/answer_page.html -->
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>答题页 - Python面试题学习系统</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='icons/font-awesome.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
  </head>
  <body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('main.index') }}"
          >Python面试题系统</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.index') }}">首页</a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('question.question_category') }}"
                >题库分类</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('interview.mock_interview') }}"
                >模拟面试</a
              >
            </li>
            <li class="nav-item"><a class="nav-link" href="#">我的进度</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-4">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0" id="questionTitle">加载题目中...</h5>
          <span class="badge bg-danger" id="countdown">10:00</span>
        </div>
        <div class="card-body">
          <p class="text-muted" id="questionType">题目类型 | 难度：加载中...</p>
          <form id="answerForm">
            <input
              type="hidden"
              name="question_id"
              id="questionId"
              value="{{ question_id }}"
            />
            <div class="list-group mb-4" id="optionList">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">正在加载题目选项...</p>
              </div>
            </div>
            <button
              type="submit"
              class="btn btn-primary"
              id="submitBtn"
              disabled
            >
              <span
                class="spinner-border spinner-border-sm me-2 d-none"
                id="submitSpinner"
              ></span>
              提交答案
            </button>
            <a
              href="{{ url_for('question.question_category') }}"
              class="btn btn-secondary ms-2"
              >返回题库</a
            >
          </form>
        </div>
      </div>
    </div>

    <footer class="mt-5 py-3 bg-light text-center">
      <p>© 2024 Python面试题学习系统（单机版）| Flask后端 + 本地数据库</p>
    </footer>

    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
      const API_BASE = "/question/api";
      const questionId =
        new URLSearchParams(window.location.search).get("question_id") || 1;

      // 加载题目详情
      function loadQuestionDetail() {
        $.ajax({
          url: `${API_BASE}/question/${questionId}`,
          method: "GET",
          success: function (response) {
            if (response.success) {
              renderQuestion(response.data);
            } else {
              showError(response.msg);
            }
          },
          error: function () {
            showError("网络请求失败，请检查后端服务");
          },
        });
      }

      // 渲染题目
      function renderQuestion(question) {
        $("#questionTitle").text(`题目 ${question.id}：${question.title}`);
        $("#questionType").text(
          `${question.type === "single" ? "单选题" : "多选题"} | 难度：${
            question.difficulty
          }`
        );
        $("#questionId").val(question.id);

        // 渲染选项
        let optionHtml = "";
        question.options.forEach((option) => {
          const inputType = question.type === "single" ? "radio" : "checkbox";
          optionHtml += `
            <label class="list-group-item">
              <input class="form-check-input me-2" type="${inputType}" 
                     name="user_answer" value="${option.option_key}">
              ${option.option_key}. ${option.option_content}
            </label>
          `;
        });

        $("#optionList").html(optionHtml);
        $("#submitBtn").prop("disabled", false);
      }

      // 显示错误
      function showError(message) {
        $("#optionList").html(`
          <div class="alert alert-danger">
            <i class="fa fa-times-circle"></i> ${message}
          </div>
        `);
      }

      // 倒计时功能
      function initCountdown() {
        let timeLeft = 10 * 60;
        const countdownInterval = setInterval(() => {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          $("#countdown").text(
            `${minutes.toString().padStart(2, "0")}:${seconds
              .toString()
              .padStart(2, "0")}`
          );

          if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            submitAnswer();
          }
          timeLeft--;
        }, 1000);
      }

      // 提交答案
      function submitAnswer() {
        const selectedOptions = $('input[name="user_answer"]:checked');
        if (selectedOptions.length === 0) {
          alert("请选择答案后提交！");
          return false;
        }

        const userAnswers = Array.from(selectedOptions)
          .map((option) => option.value)
          .join("");

        $("#submitBtn").prop("disabled", true);
        $("#submitSpinner").removeClass("d-none");

        $.ajax({
          url: `${API_BASE}/submit_answer`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            question_id: questionId,
            user_answer: userAnswers,
          }),
          success: function (response) {
            $("#submitSpinner").addClass("d-none");
            if (response.success) {
              // 跳转到解析页
              window.location.href = `/question/explanation/${questionId}?user_answer=${userAnswers}`;
            } else {
              alert(response.msg);
              $("#submitBtn").prop("disabled", false);
            }
          },
          error: function () {
            $("#submitSpinner").addClass("d-none");
            alert("提交失败，请检查网络连接");
            $("#submitBtn").prop("disabled", false);
          },
        });
      }

      // 表单提交事件
      $("#answerForm").on("submit", function (e) {
        e.preventDefault();
        submitAnswer();
      });

      // 页面加载初始化
      $(document).ready(function () {
        loadQuestionDetail();
        initCountdown();
      });
    </script>
  </body>
</html>
