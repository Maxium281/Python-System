<!-- -*- coding: utf-8 -*- -->
<!-- templates/answer_page.html -->
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>答题页 - Python面试题学习系统</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='icons/font-awesome.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
  </head>
  <body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('main.index') }}"
          >Python面试题系统</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.index') }}">首页</a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('question.question_category') }}"
                >题库分类</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('interview.mock_interview') }}"
                >模拟面试</a
              >
            </li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('progress.progress') }}">我的进度</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-4">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0" id="questionTitle">加载题目中...</h5>
          <span class="badge bg-danger" id="countdown">10:00</span>
        </div>
        <div class="card-body">
          <p class="text-muted" id="questionType">题目类型 | 难度：加载中...</p>
          <form id="answerForm">
            <input
              type="hidden"
              name="question_id"
              id="questionId"
              value="{{ question_id }}"
            />
            <div class="list-group mb-4" id="optionList">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">正在加载题目选项...</p>
              </div>
            </div>
            <button
              type="submit"
              class="btn btn-primary"
              id="submitBtn"
              disabled
            >
              <span
                class="spinner-border spinner-border-sm me-2 d-none"
                id="submitSpinner"
              ></span>
              提交答案
            </button>
            <a
              href="{{ url_for('question.question_category') }}"
              class="btn btn-secondary ms-2"
              >返回题库</a
            >
          </form>
        </div>
      </div>
    </div>

    <footer class="mt-5 py-3 bg-light text-center">
      <p>© 2024 Python面试题学习系统（单机版）| Flask后端 + 本地数据库</p>
    </footer>

    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
      const API_BASE = "/question/api";
      const questionId =
        new URLSearchParams(window.location.search).get("question_id") || 1;

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function showError(message) {
        const optionList = document.getElementById("optionList");
        optionList.innerHTML = `
          <div class="alert alert-danger">
            <i class="fa fa-times-circle"></i> ${escapeHtml(message)}
          </div>
        `;
      }

      function getSelectedAnswer() {
        const checked = document.querySelectorAll('input[name="user_answer"]:checked');
        if (!checked || checked.length === 0) return "";
        const ans = Array.from(checked).map((i) => i.value).sort().join("");
        return ans;
      }

      function syncSubmitEnabled() {
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = !getSelectedAnswer();
      }

      async function loadQuestionDetail() {
        try {
          const res = await fetch(`${API_BASE}/question/${encodeURIComponent(questionId)}`, {
            method: "GET",
            cache: "no-store",
          });

          if (!res.ok) {
            showError(`请求失败：HTTP ${res.status}`);
            return;
          }

          const payload = await res.json();
          const ok = payload && (payload.success === true) && payload.data;
          if (!ok) {
            showError(payload?.msg || "加载失败");
            return;
          }

          renderQuestion(payload.data);
        } catch (e) {
          console.error(e);
          showError("网络请求失败，请检查后端服务");
        }
      }

      function renderQuestion(question) {
        document.getElementById("questionTitle").textContent = `题目 ${question.id}：${question.title}`;
        document.getElementById("questionType").textContent =
          `${question.type === "single" ? "单选题" : "多选题"} | 难度：${question.difficulty || "Easy"}`;
        document.getElementById("questionId").value = String(question.id);

        const optionList = document.getElementById("optionList");
        const inputType = question.type === "single" ? "radio" : "checkbox";

        let html = "";
        for (const option of (question.options || [])) {
          html += `
            <label class="list-group-item">
              <input class="form-check-input me-2" type="${inputType}"
                     name="user_answer" value="${escapeHtml(option.option_key)}">
              ${escapeHtml(option.option_key)}. ${escapeHtml(option.option_content)}
            </label>
          `;
        }
        optionList.innerHTML = html;

        // 选择后启用提交
        optionList.addEventListener("change", syncSubmitEnabled);
        syncSubmitEnabled();
      }

      function initCountdown() {
        let timeLeft = 10 * 60;
        const countdownEl = document.getElementById("countdown");

        const timer = setInterval(() => {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          countdownEl.textContent =
            `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;

          if (timeLeft <= 0) {
            clearInterval(timer);
            submitAnswer(); // 时间到自动提交（无选择会提示）
          }
          timeLeft -= 1;
        }, 1000);
      }

      async function submitAnswer() {
        const userAnswers = getSelectedAnswer();
        if (!userAnswers) {
          alert("请选择答案后提交！");
          return false;
        }

        const submitBtn = document.getElementById("submitBtn");
        const submitSpinner = document.getElementById("submitSpinner");
        submitBtn.disabled = true;
        submitSpinner.classList.remove("d-none");

        try {
          const res = await fetch(`${API_BASE}/submit_answer`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question_id: Number(questionId),
              user_answer: userAnswers,
            }),
          });

          const payload = await res.json().catch(() => null);

          submitSpinner.classList.add("d-none");

          if (!res.ok || !payload) {
            alert("提交失败，请检查网络连接");
            submitBtn.disabled = false;
            return false;
          }

          if (payload.success) {
            window.location.href = `/question/explanation/${questionId}?user_answer=${encodeURIComponent(userAnswers)}`;
            return true;
          }

          alert(payload.msg || "提交失败");
          submitBtn.disabled = false;
          return false;
        } catch (e) {
          console.error(e);
          submitSpinner.classList.add("d-none");
          alert("提交失败，请检查网络连接");
          submitBtn.disabled = false;
          return false;
        }
      }

      // 表单提交事件
      document.getElementById("answerForm").addEventListener("submit", function (e) {
        e.preventDefault();
        submitAnswer();
      });

      // 页面加载初始化
      document.addEventListener("DOMContentLoaded", function () {
        loadQuestionDetail();
        initCountdown();
      });
    </script>
  </body>
</html>
